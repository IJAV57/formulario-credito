<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Solicitud de Crédito - Google Cloud</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.1.1/dist/tesseract.min.js"></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <style>
        @media print {
            body { margin: 0; padding: 20px; }
            .no-print { display: none !important; }
        }
        .file-upload-area {
            border: 2px dashed #e5e7eb;
            transition: all 0.3s ease;
        }
        .file-upload-area:hover {
            border-color: #3b82f6;
            background-color: #f8fafc;
        }
        .file-upload-area.dragover {
            border-color: #10b981;
            background-color: #ecfdf5;
        }
        .progress-bar {
            transition: width 0.3s ease;
        }
        .loading-spinner {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Header -->
    <header class="bg-blue-600 text-white shadow-lg">
        <div class="container mx-auto px-4 py-6">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <i class="fas fa-university text-3xl"></i>
                    <div>
                        <h1 class="text-2xl font-bold">Sistema de Solicitud de Crédito</h1>
                        <p class="text-blue-200">Integrado con Google Cloud Platform</p>
                    </div>
                </div>
                <div class="text-right">
                    <div id="connection-status" class="flex items-center space-x-2">
                        <span class="w-3 h-3 bg-red-400 rounded-full"></span>
                        <span class="text-sm">No conectado</span>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <div class="container mx-auto px-4 py-8 max-w-6xl">
        
        <!-- Configuración de Google Cloud -->
        <div id="google-config" class="bg-white rounded-lg shadow-md p-6 mb-8">
            <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                <i class="fas fa-cogs text-blue-600 mr-2"></i>
                Configuración de Google Cloud Platform
            </h2>
            
            <div class="grid md:grid-cols-2 gap-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        ID de Cliente OAuth 2.0
                    </label>
                    <input type="text" id="google-client-id" 
                           placeholder="123456789-abcdef.apps.googleusercontent.com"
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <p class="text-xs text-gray-500 mt-1">Obténlo en Google Cloud Console → APIs y servicios → Credenciales</p>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Nombre del Bucket de Storage
                    </label>
                    <input type="text" id="storage-bucket" 
                           placeholder="documentos-credito-123456"
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <p class="text-xs text-gray-500 mt-1">Nombre del bucket donde se guardarán los documentos</p>
                </div>
            </div>
            
            <div class="mt-4 flex space-x-3">
                <button id="connect-google" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-md flex items-center space-x-2">
                    <i class="fab fa-google"></i>
                    <span>Conectar con Google</span>
                </button>
                <button id="test-connection" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md" disabled>
                    <i class="fas fa-plug"></i>
                    Probar Conexión
                </button>
            </div>
        </div>

        <!-- Instrucciones de Configuración -->
        <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-8">
            <div class="flex">
                <div class="flex-shrink-0">
                    <i class="fas fa-exclamation-triangle text-yellow-400"></i>
                </div>
                <div class="ml-3">
                    <p class="text-sm text-yellow-700">
                        <strong>Instrucciones de configuración:</strong>
                        <br>1. Ve a <a href="https://console.cloud.google.com/" target="_blank" class="underline">Google Cloud Console</a>
                        <br>2. Crea un proyecto nuevo
                        <br>3. Habilita las APIs: Google Drive API y Cloud Storage API
                        <br>4. Crea credenciales OAuth 2.0 en "APIs y servicios" → "Credenciales"
                        <br>5. Agrega tu dominio a "Orígenes autorizados de JavaScript"
                        <br>6. Crea un bucket en Cloud Storage para almacenar documentos
                        <br>7. Copia el ID de cliente y nombre del bucket en los campos de arriba
                    </p>
                </div>
            </div>
        </div>

        <!-- Formulario Principal -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-8">
            <h2 class="text-xl font-bold text-gray-800 mb-6 flex items-center">
                <i class="fas fa-file-alt text-blue-600 mr-2"></i>
                Solicitud de Crédito
            </h2>

            <!-- Tipo de Persona -->
            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700 mb-3">Tipo de Solicitante</label>
                <div class="flex space-x-4">
                    <label class="flex items-center">
                        <input type="radio" name="tipo-persona" value="fisica" class="mr-2" checked>
                        <span class="text-sm">Persona Física</span>
                    </label>
                    <label class="flex items-center">
                        <input type="radio" name="tipo-persona" value="moral" class="mr-2">
                        <span class="text-sm">Persona Moral</span>
                    </label>
                </div>
            </div>

            <!-- Datos Básicos -->
            <div id="datos-basicos" class="mb-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">Datos Básicos</h3>
                <div class="grid md:grid-cols-2 gap-4">
                    <div id="campo-nombre">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Nombre Completo</label>
                        <input type="text" id="nombre-completo" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div id="campo-razon-social" style="display:none;">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Razón Social</label>
                        <input type="text" id="razon-social" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">RFC</label>
                        <input type="text" id="rfc" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Teléfono</label>
                        <input type="tel" id="telefono" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                </div>
                
                <div class="mt-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Dirección Completa</label>
                    <input type="text" id="direccion" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                
                <div class="grid md:grid-cols-3 gap-4 mt-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Delegación/Municipio</label>
                        <input type="text" id="delegacion" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Código Postal</label>
                        <input type="text" id="codigo-postal" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div id="campo-representante" style="display:none;">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Representante Legal</label>
                        <input type="text" id="representante-legal" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                </div>
            </div>

            <!-- Documentos Requeridos -->
            <div id="documentos-section">
                <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                    <i class="fas fa-upload text-green-600 mr-2"></i>
                    Documentos Requeridos
                </h3>
                
                <!-- Documentos Persona Física -->
                <div id="docs-persona-fisica">
                    <h4 class="font-medium text-gray-700 mb-3">Documentos del Titular</h4>
                    <div class="grid gap-4">
                        <div class="document-upload" data-required="true" data-doc-type="constancia-fiscal-titular">
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Constancia de Situación Fiscal reciente <span class="text-red-500">*</span>
                            </label>
                            <div class="file-upload-area rounded-lg p-4 text-center cursor-pointer">
                                <i class="fas fa-cloud-upload-alt text-3xl text-gray-400 mb-2"></i>
                                <p class="text-sm text-gray-600">Arrastra el archivo aquí o haz clic para seleccionar</p>
                                <p class="text-xs text-gray-500">PDF nativo o imagen de alta calidad</p>
                                <input type="file" class="hidden" accept=".pdf,.jpg,.jpeg,.png" multiple>
                                <div class="upload-status mt-2"></div>
                                <div class="progress-container hidden mt-2">
                                    <div class="bg-gray-200 rounded-full h-2">
                                        <div class="progress-bar bg-blue-600 h-2 rounded-full" style="width: 0%"></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="document-upload" data-required="true" data-doc-type="identificacion-titular">
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Identificación oficial vigente <span class="text-red-500">*</span>
                            </label>
                            <div class="file-upload-area rounded-lg p-4 text-center cursor-pointer">
                                <i class="fas fa-id-card text-3xl text-gray-400 mb-2"></i>
                                <p class="text-sm text-gray-600">Arrastra el archivo aquí o haz clic para seleccionar</p>
                                <input type="file" class="hidden" accept=".pdf,.jpg,.jpeg,.png" multiple>
                                <div class="upload-status mt-2"></div>
                                <div class="progress-container hidden mt-2">
                                    <div class="bg-gray-200 rounded-full h-2">
                                        <div class="progress-bar bg-blue-600 h-2 rounded-full" style="width: 0%"></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="document-upload" data-required="true" data-doc-type="estado-cuenta">
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Estado de cuenta bancario (máximo 3 meses) <span class="text-red-500">*</span>
                            </label>
                            <div class="file-upload-area rounded-lg p-4 text-center cursor-pointer">
                                <i class="fas fa-university text-3xl text-gray-400 mb-2"></i>
                                <p class="text-sm text-gray-600">Solo la carátula</p>
                                <input type="file" class="hidden" accept=".pdf,.jpg,.jpeg,.png" multiple>
                                <div class="upload-status mt-2"></div>
                                <div class="progress-container hidden mt-2">
                                    <div class="bg-gray-200 rounded-full h-2">
                                        <div class="progress-bar bg-blue-600 h-2 rounded-full" style="width: 0%"></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="document-upload" data-required="true" data-doc-type="comprobante-domicilio-titular">
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Comprobante de Domicilio del Titular <span class="text-red-500">*</span>
                            </label>
                            <div class="file-upload-area rounded-lg p-4 text-center cursor-pointer">
                                <i class="fas fa-home text-3xl text-gray-400 mb-2"></i>
                                <p class="text-sm text-gray-600">Arrastra el archivo aquí o haz clic para seleccionar</p>
                                <input type="file" class="hidden" accept=".pdf,.jpg,.jpeg,.png" multiple>
                                <div class="upload-status mt-2"></div>
                                <div class="progress-container hidden mt-2">
                                    <div class="bg-gray-200 rounded-full h-2">
                                        <div class="progress-bar bg-blue-600 h-2 rounded-full" style="width: 0%"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <h4 class="font-medium text-gray-700 mb-3 mt-6">Documentos de Avales</h4>
                    <div class="grid gap-4">
                        <div class="document-upload" data-required="true" data-doc-type="identificacion-avales">
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Identificación oficial de avales <span class="text-red-500">*</span>
                            </label>
                            <div class="file-upload-area rounded-lg p-4 text-center cursor-pointer">
                                <i class="fas fa-users text-3xl text-gray-400 mb-2"></i>
                                <p class="text-sm text-gray-600">Arrastra los archivos aquí o haz clic para seleccionar</p>
                                <p class="text-xs text-gray-500">Puedes subir 1 o 2 avales</p>
                                <input type="file" class="hidden" accept=".pdf,.jpg,.jpeg,.png" multiple>
                                <div class="upload-status mt-2"></div>
                                <div class="progress-container hidden mt-2">
                                    <div class="bg-gray-200 rounded-full h-2">
                                        <div class="progress-bar bg-blue-600 h-2 rounded-full" style="width: 0%"></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="document-upload" data-required="true" data-doc-type="comprobante-domicilio-avales">
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Comprobante de Domicilio de avales <span class="text-red-500">*</span>
                            </label>
                            <div class="file-upload-area rounded-lg p-4 text-center cursor-pointer">
                                <i class="fas fa-map-marker-alt text-3xl text-gray-400 mb-2"></i>
                                <p class="text-sm text-gray-600">Arrastra los archivos aquí o haz clic para seleccionar</p>
                                <input type="file" class="hidden" accept=".pdf,.jpg,.jpeg,.png" multiple>
                                <div class="upload-status mt-2"></div>
                                <div class="progress-container hidden mt-2">
                                    <div class="bg-gray-200 rounded-full h-2">
                                        <div class="progress-bar bg-blue-600 h-2 rounded-full" style="width: 0%"></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="document-upload" data-required="false" data-doc-type="documento-garantia">
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Documento garantía (bien inmueble) <span class="text-gray-500">(Opcional)</span>
                            </label>
                            <div class="file-upload-area rounded-lg p-4 text-center cursor-pointer">
                                <i class="fas fa-building text-3xl text-gray-400 mb-2"></i>
                                <p class="text-sm text-gray-600">Arrastra el archivo aquí o haz clic para seleccionar</p>
                                <input type="file" class="hidden" accept=".pdf,.jpg,.jpeg,.png" multiple>
                                <div class="upload-status mt-2"></div>
                                <div class="progress-container hidden mt-2">
                                    <div class="bg-gray-200 rounded-full h-2">
                                        <div class="progress-bar bg-blue-600 h-2 rounded-full" style="width: 0%"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Documentos Persona Moral -->
                <div id="docs-persona-moral" style="display:none;">
                    <h4 class="font-medium text-gray-700 mb-3">Documentos de la Empresa</h4>
                    <div class="grid gap-4">
                        <div class="document-upload" data-required="true" data-doc-type="constancia-fiscal-empresa">
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Constancia de Situación Fiscal reciente <span class="text-red-500">*</span>
                            </label>
                            <div class="file-upload-area rounded-lg p-4 text-center cursor-pointer">
                                <i class="fas fa-file-invoice text-3xl text-gray-400 mb-2"></i>
                                <p class="text-sm text-gray-600">Arrastra el archivo aquí o haz clic para seleccionar</p>
                                <input type="file" class="hidden" accept=".pdf,.jpg,.jpeg,.png" multiple>
                                <div class="upload-status mt-2"></div>
                                <div class="progress-container hidden mt-2">
                                    <div class="bg-gray-200 rounded-full h-2">
                                        <div class="progress-bar bg-blue-600 h-2 rounded-full" style="width: 0%"></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="document-upload" data-required="true" data-doc-type="acta-constitutiva">
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Acta Constitutiva <span class="text-red-500">*</span>
                            </label>
                            <div class="file-upload-area rounded-lg p-4 text-center cursor-pointer">
                                <i class="fas fa-certificate text-3xl text-gray-400 mb-2"></i>
                                <p class="text-sm text-gray-600">Arrastra el archivo aquí o haz clic para seleccionar</p>
                                <input type="file" class="hidden" accept=".pdf,.jpg,.jpeg,.png" multiple>
                                <div class="upload-status mt-2"></div>
                                <div class="progress-container hidden mt-2">
                                    <div class="bg-gray-200 rounded-full h-2">
                                        <div class="progress-bar bg-blue-600 h-2 rounded-full" style="width: 0%"></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="document-upload" data-required="true" data-doc-type="estados-financieros">
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Estados financieros vigentes y originales <span class="text-red-500">*</span>
                            </label>
                            <div class="file-upload-area rounded-lg p-4 text-center cursor-pointer">
                                <i class="fas fa-chart-line text-3xl text-gray-400 mb-2"></i>
                                <p class="text-sm text-gray-600">Firmados por representante legal y contador</p>
                                <input type="file" class="hidden" accept=".pdf,.jpg,.jpeg,.png" multiple>
                                <div class="upload-status mt-2"></div>
                                <div class="progress-container hidden mt-2">
                                    <div class="bg-gray-200 rounded-full h-2">
                                        <div class="progress-bar bg-blue-600 h-2 rounded-full" style="width: 0%"></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="document-upload" data-required="true" data-doc-type="cedula-contador">
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Cédula Profesional del contador <span class="text-red-500">*</span>
                            </label>
                            <div class="file-upload-area rounded-lg p-4 text-center cursor-pointer">
                                <i class="fas fa-user-graduate text-3xl text-gray-400 mb-2"></i>
                                <p class="text-sm text-gray-600">Arrastra el archivo aquí o haz clic para seleccionar</p>
                                <input type="file" class="hidden" accept=".pdf,.jpg,.jpeg,.png" multiple>
                                <div class="upload-status mt-2"></div>
                                <div class="progress-container hidden mt-2">
                                    <div class="bg-gray-200 rounded-full h-2">
                                        <div class="progress-bar bg-blue-600 h-2 rounded-full" style="width: 0%"></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="document-upload" data-required="true" data-doc-type="comprobante-domicilio-empresa">
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Comprobante de Domicilio de la empresa <span class="text-red-500">*</span>
                            </label>
                            <div class="file-upload-area rounded-lg p-4 text-center cursor-pointer">
                                <i class="fas fa-building text-3xl text-gray-400 mb-2"></i>
                                <p class="text-sm text-gray-600">Arrastra el archivo aquí o haz clic para seleccionar</p>
                                <input type="file" class="hidden" accept=".pdf,.jpg,.jpeg,.png" multiple>
                                <div class="upload-status mt-2"></div>
                                <div class="progress-container hidden mt-2">
                                    <div class="bg-gray-200 rounded-full h-2">
                                        <div class="progress-bar bg-blue-600 h-2 rounded-full" style="width: 0%"></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="document-upload" data-required="true" data-doc-type="declaracion-anual">
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Declaración Anual <span class="text-red-500">*</span>
                            </label>
                            <div class="file-upload-area rounded-lg p-4 text-center cursor-pointer">
                                <i class="fas fa-file-alt text-3xl text-gray-400 mb-2"></i>
                                <p class="text-sm text-gray-600">Arrastra el archivo aquí o haz clic para seleccionar</p>
                                <input type="file" class="hidden" accept=".pdf,.jpg,.jpeg,.png" multiple>
                                <div class="upload-status mt-2"></div>
                                <div class="progress-container hidden mt-2">
                                    <div class="bg-gray-200 rounded-full h-2">
                                        <div class="progress-bar bg-blue-600 h-2 rounded-full" style="width: 0%"></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="document-upload" data-required="true" data-doc-type="opinion-cumplimiento">
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Opinión de Cumplimiento SAT <span class="text-red-500">*</span>
                            </label>
                            <div class="file-upload-area rounded-lg p-4 text-center cursor-pointer">
                                <i class="fas fa-check-circle text-3xl text-gray-400 mb-2"></i>
                                <p class="text-sm text-gray-600">Arrastra el archivo aquí o haz clic para seleccionar</p>
                                <input type="file" class="hidden" accept=".pdf,.jpg,.jpeg,.png" multiple>
                                <div class="upload-status mt-2"></div>
                                <div class="progress-container hidden mt-2">
                                    <div class="bg-gray-200 rounded-full h-2">
                                        <div class="progress-bar bg-blue-600 h-2 rounded-full" style="width: 0%"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <h4 class="font-medium text-gray-700 mb-3 mt-6">Documentos del Representante Legal</h4>
                    <div class="grid gap-4">
                        <div class="document-upload" data-required="true" data-doc-type="identificacion-representante">
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Identificación oficial del representante legal <span class="text-red-500">*</span>
                            </label>
                            <div class="file-upload-area rounded-lg p-4 text-center cursor-pointer">
                                <i class="fas fa-id-card text-3xl text-gray-400 mb-2"></i>
                                <p class="text-sm text-gray-600">Arrastra el archivo aquí o haz clic para seleccionar</p>
                                <input type="file" class="hidden" accept=".pdf,.jpg,.jpeg,.png" multiple>
                                <div class="upload-status mt-2"></div>
                                <div class="progress-container hidden mt-2">
                                    <div class="bg-gray-200 rounded-full h-2">
                                        <div class="progress-bar bg-blue-600 h-2 rounded-full" style="width: 0%"></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="document-upload" data-required="true" data-doc-type="comprobante-domicilio-representante">
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Comprobante de Domicilio del representante legal <span class="text-red-500">*</span>
                            </label>
                            <div class="file-upload-area rounded-lg p-4 text-center cursor-pointer">
                                <i class="fas fa-home text-3xl text-gray-400 mb-2"></i>
                                <p class="text-sm text-gray-600">Arrastra el archivo aquí o haz clic para seleccionar</p>
                                <input type="file" class="hidden" accept=".pdf,.jpg,.jpeg,.png" multiple>
                                <div class="upload-status mt-2"></div>
                                <div class="progress-container hidden mt-2">
                                    <div class="bg-gray-200 rounded-full h-2">
                                        <div class="progress-bar bg-blue-600 h-2 rounded-full" style="width: 0%"></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="document-upload" data-required="true" data-doc-type="constancia-fiscal-representante">
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Constancia de Situación Fiscal del representante legal <span class="text-red-500">*</span>
                            </label>
                            <div class="file-upload-area rounded-lg p-4 text-center cursor-pointer">
                                <i class="fas fa-file-invoice text-3xl text-gray-400 mb-2"></i>
                                <p class="text-sm text-gray-600">Arrastra el archivo aquí o haz clic para seleccionar</p>
                                <input type="file" class="hidden" accept=".pdf,.jpg,.jpeg,.png" multiple>
                                <div class="upload-status mt-2"></div>
                                <div class="progress-container hidden mt-2">
                                    <div class="bg-gray-200 rounded-full h-2">
                                        <div class="progress-bar bg-blue-600 h-2 rounded-full" style="width: 0%"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <h4 class="font-medium text-gray-700 mb-3 mt-6">Documentos de Avales</h4>
                    <div class="grid gap-4">
                        <div class="document-upload" data-required="true" data-doc-type="identificacion-avales-pm">
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Identificación oficial de avales <span class="text-red-500">*</span>
                            </label>
                            <div class="file-upload-area rounded-lg p-4 text-center cursor-pointer">
                                <i class="fas fa-users text-3xl text-gray-400 mb-2"></i>
                                <p class="text-sm text-gray-600">Arrastra los archivos aquí o haz clic para seleccionar</p>
                                <input type="file" class="hidden" accept=".pdf,.jpg,.jpeg,.png" multiple>
                                <div class="upload-status mt-2"></div>
                                <div class="progress-container hidden mt-2">
                                    <div class="bg-gray-200 rounded-full h-2">
                                        <div class="progress-bar bg-blue-600 h-2 rounded-full" style="width: 0%"></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="document-upload" data-required="true" data-doc-type="comprobante-domicilio-avales-pm">
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Comprobante de Domicilio de avales <span class="text-red-500">*</span>
                            </label>
                            <div class="file-upload-area rounded-lg p-4 text-center cursor-pointer">
                                <i class="fas fa-map-marker-alt text-3xl text-gray-400 mb-2"></i>
                                <p class="text-sm text-gray-600">Arrastra los archivos aquí o haz clic para seleccionar</p>
                                <input type="file" class="hidden" accept=".pdf,.jpg,.jpeg,.png" multiple>
                                <div class="upload-status mt-2"></div>
                                <div class="progress-container hidden mt-2">
                                    <div class="bg-gray-200 rounded-full h-2">
                                        <div class="progress-bar bg-blue-600 h-2 rounded-full" style="width: 0%"></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="document-upload" data-required="true" data-doc-type="constancia-fiscal-avales">
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Constancia de Situación Fiscal de avales <span class="text-red-500">*</span>
                            </label>
                            <div class="file-upload-area rounded-lg p-4 text-center cursor-pointer">
                                <i class="fas fa-file-invoice text-3xl text-gray-400 mb-2"></i>
                                <p class="text-sm text-gray-600">Arrastra los archivos aquí o haz clic para seleccionar</p>
                                <input type="file" class="hidden" accept=".pdf,.jpg,.jpeg,.png" multiple>
                                <div class="upload-status mt-2"></div>
                                <div class="progress-container hidden mt-2">
                                    <div class="bg-gray-200 rounded-full h-2">
                                        <div class="progress-bar bg-blue-600 h-2 rounded-full" style="width: 0%"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Validaciones y Estado -->
            <div class="mt-8">
                <div id="validation-alerts" class="mb-4"></div>
                
                <div class="flex flex-wrap gap-4 items-center">
                    <button id="validate-documents" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-md flex items-center space-x-2">
                        <i class="fas fa-check-double"></i>
                        <span>Validar Documentos</span>
                    </button>
                    
                    <button id="process-documents" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-md flex items-center space-x-2" disabled>
                        <i class="fas fa-cogs"></i>
                        <span>Procesar con OCR</span>
                    </button>
                    
                    <button id="generate-pdfs" class="bg-purple-600 hover:bg-purple-700 text-white px-6 py-2 rounded-md flex items-center space-x-2" disabled>
                        <i class="fas fa-file-pdf"></i>
                        <span>Generar PDFs</span>
                    </button>
                    
                    <button id="submit-application" class="bg-red-600 hover:bg-red-700 text-white px-6 py-2 rounded-md flex items-center space-x-2" disabled>
                        <i class="fas fa-paper-plane"></i>
                        <span>Enviar Solicitud</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Progreso y Resultados -->
        <div id="processing-section" class="bg-white rounded-lg shadow-md p-6 mb-8" style="display:none;">
            <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                <i class="fas fa-tasks text-blue-600 mr-2"></i>
                Progreso del Procesamiento
            </h3>
            
            <div id="processing-steps" class="space-y-4">
                <div class="flex items-center space-x-3">
                    <div class="w-8 h-8 bg-gray-200 rounded-full flex items-center justify-center">
                        <i class="fas fa-upload text-gray-600"></i>
                    </div>
                    <span class="text-gray-600">Subiendo archivos a Google Drive...</span>
                    <div class="loading-spinner fas fa-spinner text-blue-600 hidden"></div>
                </div>
                
                <div class="flex items-center space-x-3">
                    <div class="w-8 h-8 bg-gray-200 rounded-full flex items-center justify-center">
                        <i class="fas fa-eye text-gray-600"></i>
                    </div>
                    <span class="text-gray-600">Procesando OCR de imágenes...</span>
                    <div class="loading-spinner fas fa-spinner text-blue-600 hidden"></div>
                </div>
                
                <div class="flex items-center space-x-3">
                    <div class="w-8 h-8 bg-gray-200 rounded-full flex items-center justify-center">
                        <i class="fas fa-file-pdf text-gray-600"></i>
                    </div>
                    <span class="text-gray-600">Extrayendo datos de PDFs...</span>
                    <div class="loading-spinner fas fa-spinner text-blue-600 hidden"></div>
                </div>
                
                <div class="flex items-center space-x-3">
                    <div class="w-8 h-8 bg-gray-200 rounded-full flex items-center justify-center">
                        <i class="fas fa-magic text-gray-600"></i>
                    </div>
                    <span class="text-gray-600">Autocompletando formularios...</span>
                    <div class="loading-spinner fas fa-spinner text-blue-600 hidden"></div>
                </div>
            </div>
            
            <div id="processing-results" class="mt-6" style="display:none;">
                <h4 class="font-medium text-gray-700 mb-3">Datos Extraídos</h4>
                <div id="extracted-data" class="bg-gray-50 p-4 rounded-lg">
                    <!-- Los datos extraídos aparecerán aquí -->
                </div>
            </div>
        </div>

        <!-- Descarga de PDFs -->
        <div id="download-section" class="bg-white rounded-lg shadow-md p-6" style="display:none;">
            <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                <i class="fas fa-download text-green-600 mr-2"></i>
                Descargar PDFs Prellenados
            </h3>
            
            <div class="grid md:grid-cols-2 gap-4">
                <div class="text-center p-4 border-2 border-dashed border-gray-300 rounded-lg">
                    <i class="fas fa-file-pdf text-4xl text-red-600 mb-2"></i>
                    <h4 class="font-medium text-gray-800">Autorización Buró Titular</h4>
                    <p class="text-sm text-gray-600 mb-3">PDF prellenado con datos del titular</p>
                    <button class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-md text-sm download-pdf" data-pdf-type="titular">
                        <i class="fas fa-download mr-1"></i>
                        Descargar
                    </button>
                </div>
                
                <div id="avales-pdfs" class="grid gap-4">
                    <!-- Los PDFs de avales se generarán dinámicamente -->
                </div>
            </div>
            
            <div class="mt-6 p-4 bg-blue-50 border-l-4 border-blue-400">
                <div class="flex">
                    <div class="flex-shrink-0">
                        <i class="fas fa-info-circle text-blue-400"></i>
                    </div>
                    <div class="ml-3">
                        <p class="text-sm text-blue-700">
                            <strong>Siguiente paso:</strong> Descarga todos los PDFs, imprímelos, fírmalos y entrégalos junto con los documentos originales.
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script>
        // Variables globales
        let googleAuth = null;
        let uploadedFiles = {};
        let extractedData = {};
        let isGoogleConnected = false;

        // Configuración de Google API
        const DISCOVERY_DOC = 'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest';
        const SCOPES = 'https://www.googleapis.com/auth/drive.file';

        // Inicialización
        document.addEventListener('DOMContentLoaded', function() {
            initializeEventListeners();
            loadGoogleAPI();
        });

        // Cargar Google API
        function loadGoogleAPI() {
            if (typeof gapi !== 'undefined') {
                gapi.load('auth2', initializeGoogleAuth);
            }
        }

        // Inicializar autenticación de Google
        async function initializeGoogleAuth() {
            try {
                await gapi.load('client:auth2', async () => {
                    const clientId = document.getElementById('google-client-id').value;
                    if (!clientId) return;

                    await gapi.client.init({
                        discoveryDocs: [DISCOVERY_DOC],
                        clientId: clientId,
                        scope: SCOPES
                    });

                    googleAuth = gapi.auth2.getAuthInstance();
                    updateConnectionStatus();
                });
            } catch (error) {
                console.error('Error inicializando Google Auth:', error);
                showAlert('Error al inicializar Google Auth', 'error');
            }
        }

        // Event Listeners
        function initializeEventListeners() {
            // Cambio de tipo de persona
            document.querySelectorAll('input[name="tipo-persona"]').forEach(radio => {
                radio.addEventListener('change', handlePersonTypeChange);
            });

            // Conexión con Google
            document.getElementById('connect-google').addEventListener('click', connectToGoogle);
            document.getElementById('test-connection').addEventListener('click', testGoogleConnection);

            // Botones principales
            document.getElementById('validate-documents').addEventListener('click', validateAllDocuments);
            document.getElementById('process-documents').addEventListener('click', processAllDocuments);
            document.getElementById('generate-pdfs').addEventListener('click', generateAllPDFs);
            document.getElementById('submit-application').addEventListener('click', submitApplication);

            // File uploads
            setupFileUploads();
        }

        // Manejar cambio de tipo de persona
        function handlePersonTypeChange(e) {
            const tipoPersona = e.target.value;
            
            if (tipoPersona === 'fisica') {
                document.getElementById('docs-persona-fisica').style.display = 'block';
                document.getElementById('docs-persona-moral').style.display = 'none';
                document.getElementById('campo-nombre').style.display = 'block';
                document.getElementById('campo-razon-social').style.display = 'none';
                document.getElementById('campo-representante').style.display = 'none';
            } else {
                document.getElementById('docs-persona-fisica').style.display = 'none';
                document.getElementById('docs-persona-moral').style.display = 'block';
                document.getElementById('campo-nombre').style.display = 'none';
                document.getElementById('campo-razon-social').style.display = 'block';
                document.getElementById('campo-representante').style.display = 'block';
            }
            
            // Limpiar archivos subidos
            uploadedFiles = {};
            clearFileUploads();
        }

        // Conectar con Google
        async function connectToGoogle() {
            const clientId = document.getElementById('google-client-id').value;
            if (!clientId) {
                showAlert('Por favor ingresa el ID de Cliente OAuth 2.0', 'warning');
                return;
            }

            try {
                await initializeGoogleAuth();
                if (googleAuth) {
                    await googleAuth.signIn();
                    isGoogleConnected = true;
                    updateConnectionStatus();
                    document.getElementById('test-connection').disabled = false;
                    showAlert('Conectado exitosamente con Google Drive', 'success');
                }
            } catch (error) {
                console.error('Error conectando con Google:', error);
                showAlert('Error al conectar con Google: ' + error.message, 'error');
            }
        }

        // Probar conexión
        async function testGoogleConnection() {
            if (!isGoogleConnected) {
                showAlert('Primero debes conectarte con Google', 'warning');
                return;
            }

            try {
                const response = await gapi.client.drive.files.list({
                    pageSize: 1,
                    fields: 'files(id, name)'
                });
                showAlert('Conexión con Google Drive verificada correctamente', 'success');
            } catch (error) {
                showAlert('Error en la conexión: ' + error.message, 'error');
            }
        }

        // Actualizar estado de conexión
        function updateConnectionStatus() {
            const statusElement = document.getElementById('connection-status');
            if (isGoogleConnected) {
                statusElement.innerHTML = `
                    <span class="w-3 h-3 bg-green-400 rounded-full"></span>
                    <span class="text-sm">Conectado</span>
                `;
            } else {
                statusElement.innerHTML = `
                    <span class="w-3 h-3 bg-red-400 rounded-full"></span>
                    <span class="text-sm">No conectado</span>
                `;
            }
        }

        // Configurar file uploads
        function setupFileUploads() {
            document.querySelectorAll('.document-upload').forEach(uploadArea => {
                const fileInput = uploadArea.querySelector('input[type="file"]');
                const uploadZone = uploadArea.querySelector('.file-upload-area');

                // Click para seleccionar archivo
                uploadZone.addEventListener('click', () => fileInput.click());

                // Drag and drop
                uploadZone.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    uploadZone.classList.add('dragover');
                });

                uploadZone.addEventListener('dragleave', () => {
                    uploadZone.classList.remove('dragover');
                });

                uploadZone.addEventListener('drop', (e) => {
                    e.preventDefault();
                    uploadZone.classList.remove('dragover');
                    handleFileUpload(e.dataTransfer.files, uploadArea);
                });

                // File input change
                fileInput.addEventListener('change', (e) => {
                    handleFileUpload(e.target.files, uploadArea);
                });
            });
        }

        // Manejar subida de archivos
        async function handleFileUpload(files, uploadArea) {
            const docType = uploadArea.dataset.docType;
            const statusElement = uploadArea.querySelector('.upload-status');
            const progressContainer = uploadArea.querySelector('.progress-container');
            const progressBar = uploadArea.querySelector('.progress-bar');

            for (let file of files) {
                // Validar archivo
                const validation = await validateFile(file);
                if (!validation.valid) {
                    showAlert(`Error en ${file.name}: ${validation.message}`, 'error');
                    continue;
                }

                // Mostrar progreso
                progressContainer.classList.remove('hidden');
                statusElement.innerHTML = `<span class="text-blue-600">Subiendo ${file.name}...</span>`;

                try {
                    // Simular progreso de subida
                    for (let i = 0; i <= 100; i += 10) {
                        progressBar.style.width = i + '%';
                        await new Promise(resolve => setTimeout(resolve, 100));
                    }

                    // Guardar archivo
                    if (!uploadedFiles[docType]) {
                        uploadedFiles[docType] = [];
                    }
                    uploadedFiles[docType].push({
                        file: file,
                        name: file.name,
                        type: file.type,
                        validated: true
                    });

                    statusElement.innerHTML = `<span class="text-green-600"><i class="fas fa-check mr-1"></i>${file.name} subido correctamente</span>`;
                    progressContainer.classList.add('hidden');

                } catch (error) {
                    statusElement.innerHTML = `<span class="text-red-600"><i class="fas fa-times mr-1"></i>Error subiendo ${file.name}</span>`;
                    progressContainer.classList.add('hidden');
                }
            }
        }

        // Validar archivo
        async function validateFile(file) {
            const maxSize = 10 * 1024 * 1024; // 10MB
            const allowedTypes = ['application/pdf', 'image/jpeg', 'image/jpg', 'image/png'];

            if (file.size > maxSize) {
                return { valid: false, message: 'El archivo es demasiado grande (máximo 10MB)' };
            }

            if (!allowedTypes.includes(file.type)) {
                return { valid: false, message: 'Tipo de archivo no permitido' };
            }

            // Validación específica para PDFs
            if (file.type === 'application/pdf') {
                const isNative = await validateNativePDF(file);
                if (!isNative) {
                    return { valid: false, message: 'El PDF debe ser nativo, no una imagen escaneada' };
                }
            }

            // Validación específica para imágenes
            if (file.type.startsWith('image/')) {
                const quality = await validateImageQuality(file);
                if (!quality.valid) {
                    return { valid: false, message: quality.message };
                }
            }

            return { valid: true, message: 'Archivo válido' };
        }

        // Validar PDF nativo
        async function validateNativePDF(file) {
            try {
                const arrayBuffer = await file.arrayBuffer();
                const text = new TextDecoder().decode(arrayBuffer.slice(0, 1024));
                
                // Buscar indicadores de PDF nativo
                const hasText = text.includes('/Type') && text.includes('/Font');
                const hasImages = text.includes('/XObject') && text.includes('/Image');
                
                // Si solo tiene imágenes y no texto/fuentes, probablemente es escaneado
                return hasText || !hasImages;
            } catch (error) {
                return false;
            }
        }

        // Validar calidad de imagen para OCR
        async function validateImageQuality(file) {
            return new Promise((resolve) => {
                const img = new Image();
                img.onload = function() {
                    const minWidth = 800;
                    const minHeight = 600;
                    const minPixels = minWidth * minHeight;
                    
                    if (img.width < minWidth || img.height < minHeight) {
                        resolve({
                            valid: false,
                            message: `Resolución muy baja (${img.width}x${img.height}). Mínimo requerido: ${minWidth}x${minHeight}`
                        });
                    } else {
                        resolve({ valid: true });
                    }
                };
                img.onerror = () => resolve({ valid: false, message: 'No se pudo cargar la imagen' });
                img.src = URL.createObjectURL(file);
            });
        }

        // Validar todos los documentos
        function validateAllDocuments() {
            const tipoPersona = document.querySelector('input[name="tipo-persona"]:checked').value;
            const requiredDocs = getRequiredDocuments(tipoPersona);
            const missingDocs = [];

            requiredDocs.forEach(docType => {
                if (!uploadedFiles[docType] || uploadedFiles[docType].length === 0) {
                    missingDocs.push(getDocumentName(docType));
                }
            });

            if (missingDocs.length > 0) {
                showAlert(`Faltan los siguientes documentos: ${missingDocs.join(', ')}`, 'warning');
                return false;
            }

            showAlert('Todos los documentos requeridos han sido subidos', 'success');
            document.getElementById('process-documents').disabled = false;
            return true;
        }

        // Obtener documentos requeridos por tipo de persona
        function getRequiredDocuments(tipoPersona) {
            if (tipoPersona === 'fisica') {
                return [
                    'constancia-fiscal-titular',
                    'identificacion-titular',
                    'estado-cuenta',
                    'comprobante-domicilio-titular',
                    'identificacion-avales',
                    'comprobante-domicilio-avales'
                ];
            } else {
                return [
                    'constancia-fiscal-empresa',
                    'acta-constitutiva',
                    'estados-financieros',
                    'cedula-contador',
                    'comprobante-domicilio-empresa',
                    'declaracion-anual',
                    'opinion-cumplimiento',
                    'identificacion-representante',
                    'comprobante-domicilio-representante',
                    'constancia-fiscal-representante',
                    'identificacion-avales-pm',
                    'comprobante-domicilio-avales-pm',
                    'constancia-fiscal-avales'
                ];
            }
        }

        // Obtener nombre legible del documento
        function getDocumentName(docType) {
            const names = {
                'constancia-fiscal-titular': 'Constancia de Situación Fiscal del titular',
                'identificacion-titular': 'Identificación del titular',
                'estado-cuenta': 'Estado de cuenta bancario',
                'comprobante-domicilio-titular': 'Comprobante de domicilio del titular',
                'identificacion-avales': 'Identificación de avales',
                'comprobante-domicilio-avales': 'Comprobante de domicilio de avales',
                'constancia-fiscal-empresa': 'Constancia de Situación Fiscal de la empresa',
                'acta-constitutiva': 'Acta Constitutiva',
                'estados-financieros': 'Estados financieros',
                'cedula-contador': 'Cédula Profesional del contador',
                'comprobante-domicilio-empresa': 'Comprobante de domicilio de la empresa',
                'declaracion-anual': 'Declaración Anual',
                'opinion-cumplimiento': 'Opinión de Cumplimiento SAT',
                'identificacion-representante': 'Identificación del representante legal',
                'comprobante-domicilio-representante': 'Comprobante de domicilio del representante',
                'constancia-fiscal-representante': 'Constancia Situación Fiscal del representante',
                'identificacion-avales-pm': 'Identificación de avales',
                'comprobante-domicilio-avales-pm': 'Comprobante de domicilio de avales',
                'constancia-fiscal-avales': 'Constancia Situación Fiscal de avales'
            };
            return names[docType] || docType;
        }

        // Procesar todos los documentos
        async function processAllDocuments() {
            if (!isGoogleConnected) {
                showAlert('Debes conectarte con Google Drive primero', 'warning');
                return;
            }

            document.getElementById('processing-section').style.display = 'block';
            
            try {
                // Subir archivos a Google Drive
                await uploadFilesToDrive();
                
                // Procesar OCR de imágenes
                await processOCRImages();
                
                // Extraer datos de PDFs
                await extractPDFData();
                
                // Autocompletar formularios
                await autoFillForms();
                
                document.getElementById('generate-pdfs').disabled = false;
                showAlert('Documentos procesados exitosamente', 'success');
                
            } catch (error) {
                console.error('Error procesando documentos:', error);
                showAlert('Error procesando documentos: ' + error.message, 'error');
            }
        }

        // Subir archivos a Google Drive
        async function uploadFilesToDrive() {
            updateProcessingStep(0, true);
            
            const bucketName = document.getElementById('storage-bucket').value;
            if (!bucketName) {
                throw new Error('Debes configurar el nombre del bucket');
            }

            // Simular subida a Drive (aquí implementarías la lógica real)
            await new Promise(resolve => setTimeout(resolve, 2000));
            
            updateProcessingStep(0, false, true);
        }

        // Procesar OCR de imágenes
        async function processOCRImages() {
            updateProcessingStep(1, true);
            
            for (const [docType, files] of Object.entries(uploadedFiles)) {
                for (const fileData of files) {
                    if (fileData.file.type.startsWith('image/')) {
                        try {
                            const result = await Tesseract.recognize(fileData.file, 'spa', {
                                logger: m => console.log(m)
                            });
                            
                            if (!extractedData[docType]) {
                                extractedData[docType] = [];
                            }
                            extractedData[docType].push({
                                fileName: fileData.name,
                                text: result.data.text,
                                confidence: result.data.confidence
                            });
                        } catch (error) {
                            console.error(`Error en OCR para ${fileData.name}:`, error);
                        }
                    }
                }
            }
            
            updateProcessingStep(1, false, true);
        }

        // Extraer datos de PDFs
        async function extractPDFData() {
            updateProcessingStep(2, true);
            
            for (const [docType, files] of Object.entries(uploadedFiles)) {
                for (const fileData of files) {
                    if (fileData.file.type === 'application/pdf') {
                        try {
                            const arrayBuffer = await fileData.file.arrayBuffer();
                            const pdfDoc = await PDFLib.PDFDocument.load(arrayBuffer);
                            
                            // Extraer texto del PDF (implementación simplificada)
                            const pages = pdfDoc.getPages();
                            let text = '';
                            
                            // Aquí implementarías la extracción real de texto del PDF
                            // Por ahora simularemos
                            text = 'Texto extraído del PDF simulado';
                            
                            if (!extractedData[docType]) {
                                extractedData[docType] = [];
                            }
                            extractedData[docType].push({
                                fileName: fileData.name,
                                text: text,
                                confidence: 95
                            });
                        } catch (error) {
                            console.error(`Error extrayendo PDF ${fileData.name}:`, error);
                        }
                    }
                }
            }
            
            updateProcessingStep(2, false, true);
        }

        // Autocompletar formularios
        async function autoFillForms() {
            updateProcessingStep(3, true);
            
            // Extraer datos específicos del texto procesado
            const formData = extractFormData();
            
            // Llenar campos del formulario
            fillFormFields(formData);
            
            // Mostrar datos extraídos
            displayExtractedData(formData);
            
            updateProcessingStep(3, false, true);
            document.getElementById('processing-results').style.display = 'block';
        }

        // Extraer datos del formulario
        function extractFormData() {
            const tipoPersona = document.querySelector('input[name="tipo-persona"]:checked').value;
            const formData = {
                tipoPersona: tipoPersona,
                rfc: '',
                nombre: '',
                razonSocial: '',
                direccion: '',
                delegacion: '',
                codigoPostal: '',
                telefono: '',
                representanteLegal: '',
                fecha: new Date().toLocaleDateString('es-MX')
            };

            // Simular extracción de datos (aquí implementarías la lógica real de parsing)
            // Por ejemplo, buscar patrones de RFC, nombres, direcciones, etc.
            
            for (const [docType, data] of Object.entries(extractedData)) {
                for (const extraction of data) {
                    const text = extraction.text;
                    
                    // Buscar RFC
                    const rfcMatch = text.match(/[A-Z&Ñ]{3,4}[0-9]{6}[A-Z0-9]{3}/);
                    if (rfcMatch && !formData.rfc) {
                        formData.rfc = rfcMatch[0];
                    }
                    
                    // Buscar teléfono
                    const telefonoMatch = text.match(/(?:\+52\s?)?(?:\d{2,3}\s?)?\d{3,4}\s?\d{4}/);
                    if (telefonoMatch && !formData.telefono) {
                        formData.telefono = telefonoMatch[0];
                    }
                    
                    // Buscar código postal
                    const cpMatch = text.match(/\b\d{5}\b/);
                    if (cpMatch && !formData.codigoPostal) {
                        formData.codigoPostal = cpMatch[0];
                    }
                }
            }

            return formData;
        }

        // Llenar campos del formulario
        function fillFormFields(formData) {
            if (formData.rfc) document.getElementById('rfc').value = formData.rfc;
            if (formData.telefono) document.getElementById('telefono').value = formData.telefono;
            if (formData.codigoPostal) document.getElementById('codigo-postal').value = formData.codigoPostal;
            if (formData.nombre) document.getElementById('nombre-completo').value = formData.nombre;
            if (formData.razonSocial) document.getElementById('razon-social').value = formData.razonSocial;
            if (formData.representanteLegal) document.getElementById('representante-legal').value = formData.representanteLegal;
        }

        // Mostrar datos extraídos
        function displayExtractedData(formData) {
            const container = document.getElementById('extracted-data');
            let html = '<div class="grid md:grid-cols-2 gap-4">';
            
            for (const [key, value] of Object.entries(formData)) {
                if (value) {
                    html += `
                        <div class="flex justify-between py-1 border-b border-gray-200">
                            <span class="font-medium text-gray-700">${key}:</span>
                            <span class="text-gray-900">${value}</span>
                        </div>
                    `;
                }
            }
            
            html += '</div>';
            container.innerHTML = html;
        }

        // Actualizar paso de procesamiento
        function updateProcessingStep(stepIndex, isActive, isCompleted = false) {
            const steps = document.querySelectorAll('#processing-steps > div');
            const step = steps[stepIndex];
            const icon = step.querySelector('i:first-child');
            const spinner = step.querySelector('.loading-spinner');
            const text = step.querySelector('span');

            if (isActive) {
                spinner.classList.remove('hidden');
                icon.className = 'fas fa-spinner loading-spinner';
                text.classList.add('text-blue-600');
            } else if (isCompleted) {
                spinner.classList.add('hidden');
                icon.className = 'fas fa-check';
                icon.parentElement.classList.remove('bg-gray-200');
                icon.parentElement.classList.add('bg-green-500');
                icon.classList.remove('text-gray-600');
                icon.classList.add('text-white');
                text.classList.remove('text-blue-600');
                text.classList.add('text-green-600');
            }
        }

        // Generar todos los PDFs
        async function generateAllPDFs() {
            try {
                const tipoPersona = document.querySelector('input[name="tipo-persona"]:checked').value;
                const formData = extractFormData();
                
                // Llenar datos desde el formulario si no se extrajeron
                formData.rfc = formData.rfc || document.getElementById('rfc').value;
                formData.telefono = formData.telefono || document.getElementById('telefono').value;
                formData.direccion = formData.direccion || document.getElementById('direccion').value;
                formData.delegacion = formData.delegacion || document.getElementById('delegacion').value;
                formData.codigoPostal = formData.codigoPostal || document.getElementById('codigo-postal').value;
                
                if (tipoPersona === 'fisica') {
                    formData.nombre = formData.nombre || document.getElementById('nombre-completo').value;
                    await generatePDFPersonaFisica(formData);
                } else {
                    formData.razonSocial = formData.razonSocial || document.getElementById('razon-social').value;
                    formData.representanteLegal = formData.representanteLegal || document.getElementById('representante-legal').value;
                    await generatePDFPersonaMoral(formData);
                }
                
                document.getElementById('download-section').style.display = 'block';
                document.getElementById('submit-application').disabled = false;
                showAlert('PDFs generados exitosamente', 'success');
                
            } catch (error) {
                console.error('Error generando PDFs:', error);
                showAlert('Error generando PDFs: ' + error.message, 'error');
            }
        }

        // Generar PDF para persona física
        async function generatePDFPersonaFisica(formData) {
            // Crear PDF para titular
            const pdfTitular = await createBuroPDF({
                tipo: 'PF',
                rfc: formData.rfc,
                calle: formData.direccion,
                delegacion: formData.delegacion,
                cp: formData.codigoPostal,
                telefono: formData.telefono,
                fecha: formData.fecha,
                nombreCliente1: formData.nombre,
                nombreCliente2: ''
            });
            
            // Guardar PDF del titular
            savePDF(pdfTitular, 'Autorizacion_Buro_Titular.pdf', 'titular');
            
            // Generar PDFs para avales (simular datos de avales)
            const numAvales = Math.min(2, (uploadedFiles['identificacion-avales'] || []).length);
            for (let i = 1; i <= numAvales; i++) {
                const pdfAval = await createBuroPDF({
                    tipo: 'PF',
                    rfc: `AVAL${i}RFC`, // En producción, extraerías esto de los documentos
                    calle: `Dirección Aval ${i}`,
                    delegacion: formData.delegacion,
                    cp: formData.codigoPostal,
                    telefono: `55555555${i}`,
                    fecha: formData.fecha,
                    nombreCliente1: `Aval ${i}`,
                    nombreCliente2: ''
                });
                
                savePDF(pdfAval, `Autorizacion_Buro_Aval_${i}.pdf`, `aval-${i}`);
            }
        }

        // Generar PDF para persona moral
        async function generatePDFPersonaMoral(formData) {
            const pdf = await createBuroPDF({
                tipo: 'PM',
                razonSocial: formData.razonSocial,
                rfcEmpresa: formData.rfc,
                calleEmpresa: formData.direccion,
                delegacionEmpresa: formData.delegacion,
                cpEmpresa: formData.codigoPostal,
                telefonoEmpresa: formData.telefono,
                fechaEmpresa: formData.fecha,
                nombreRepresentante: formData.representanteLegal
            });
            
            savePDF(pdf, 'Autorizacion_Buro_Empresa.pdf', 'empresa');
        }

        // Crear PDF de autorización de buró
        async function createBuroPDF(data) {
            const pdfDoc = await PDFLib.PDFDocument.create();
            const page = pdfDoc.addPage([612, 792]); // Tamaño carta
            const font = await pdfDoc.embedFont(PDFLib.StandardFonts.Helvetica);
            const fontSize = 12;

            // Título
            page.drawText('AUTORIZACIÓN PARA CONSULTA EN BURÓ DE CRÉDITO', {
                x: 150,
                y: 750,
                size: 14,
                font: font
            });

            if (data.tipo === 'PF') {
                // Campos para Persona Física
                page.drawText(`RFC: ${data.rfc || ''}`, { x: 50, y: 700, size: fontSize, font });
                page.drawText(`Nombre: ${data.nombreCliente1 || ''}`, { x: 50, y: 680, size: fontSize, font });
                page.drawText(`Calle: ${data.calle || ''}`, { x: 50, y: 660, size: fontSize, font });
                page.drawText(`Delegación: ${data.delegacion || ''}`, { x: 50, y: 640, size: fontSize, font });
                page.drawText(`C.P.: ${data.cp || ''}`, { x: 50, y: 620, size: fontSize, font });
                page.drawText(`Teléfono: ${data.telefono || ''}`, { x: 50, y: 600, size: fontSize, font });
                page.drawText(`Fecha: ${data.fecha || ''}`, { x: 50, y: 580, size: fontSize, font });
            } else {
                // Campos para Persona Moral
                page.drawText(`Razón Social: ${data.razonSocial || ''}`, { x: 50, y: 700, size: fontSize, font });
                page.drawText(`RFC Empresa: ${data.rfcEmpresa || ''}`, { x: 50, y: 680, size: fontSize, font });
                page.drawText(`Calle: ${data.calleEmpresa || ''}`, { x: 50, y: 660, size: fontSize, font });
                page.drawText(`Delegación: ${data.delegacionEmpresa || ''}`, { x: 50, y: 640, size: fontSize, font });
                page.drawText(`C.P.: ${data.cpEmpresa || ''}`, { x: 50, y: 620, size: fontSize, font });
                page.drawText(`Teléfono: ${data.telefonoEmpresa || ''}`, { x: 50, y: 600, size: fontSize, font });
                page.drawText(`Fecha: ${data.fechaEmpresa || ''}`, { x: 50, y: 580, size: fontSize, font });
                page.drawText(`Representante Legal: ${data.nombreRepresentante || ''}`, { x: 50, y: 560, size: fontSize, font });
            }

            // Texto de autorización
            const authText = `
Por medio de la presente autorizo a [NOMBRE DE LA EMPRESA] para que consulte mi información 
crediticia en el Buró de Crédito, así como para el tratamiento de mis datos personales 
conforme a la Ley Federal de Protección de Datos Personales.
            `;

            page.drawText(authText, {
                x: 50,
                y: 450,
                size: 10,
                font,
                maxWidth: 500,
                lineHeight: 15
            });

            // Línea para firma
            page.drawText('Firma: ________________________________', {
                x: 50,
                y: 300,
                size: fontSize,
                font
            });

            return pdfDoc;
        }

        // Guardar PDF
        function savePDF(pdfDoc, fileName, pdfType) {
            pdfDoc.save().then(pdfBytes => {
                const blob = new Blob([pdfBytes], { type: 'application/pdf' });
                const url = URL.createObjectURL(blob);
                
                // Crear botón de descarga
                createDownloadButton(url, fileName, pdfType);
            });
        }

        // Crear botón de descarga
        function createDownloadButton(url, fileName, pdfType) {
            const container = pdfType === 'titular' ? 
                document.querySelector('.download-pdf[data-pdf-type="titular"]').parentElement :
                document.getElementById('avales-pdfs');

            if (pdfType !== 'titular') {
                const downloadDiv = document.createElement('div');
                downloadDiv.className = 'text-center p-4 border-2 border-dashed border-gray-300 rounded-lg';
                downloadDiv.innerHTML = `
                    <i class="fas fa-file-pdf text-4xl text-red-600 mb-2"></i>
                    <h4 class="font-medium text-gray-800">${fileName}</h4>
                    <p class="text-sm text-gray-600 mb-3">PDF prellenado</p>
                    <button class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-md text-sm download-pdf-custom">
                        <i class="fas fa-download mr-1"></i>
                        Descargar
                    </button>
                `;
                
                const downloadBtn = downloadDiv.querySelector('.download-pdf-custom');
                downloadBtn.addEventListener('click', () => {
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = fileName;
                    a.click();
                });
                
                container.appendChild(downloadDiv);
            } else {
                document.querySelector('.download-pdf[data-pdf-type="titular"]').addEventListener('click', () => {
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = fileName;
                    a.click();
                });
            }
        }

        // Enviar solicitud
        async function submitApplication() {
            try {
                const tipoPersona = document.querySelector('input[name="tipo-persona"]:checked').value;
                const applicationData = {
                    tipoPersona: tipoPersona,
                    datosBasicos: {
                        nombre: document.getElementById('nombre-completo').value,
                        razonSocial: document.getElementById('razon-social').value,
                        rfc: document.getElementById('rfc').value,
                        telefono: document.getElementById('telefono').value,
                        direccion: document.getElementById('direccion').value,
                        delegacion: document.getElementById('delegacion').value,
                        codigoPostal: document.getElementById('codigo-postal').value,
                        representanteLegal: document.getElementById('representante-legal').value
                    },
                    documentos: uploadedFiles,
                    datosExtraidos: extractedData,
                    fechaSolicitud: new Date().toISOString()
                };

                // Aquí enviarías los datos a tu servidor
                console.log('Datos de la solicitud:', applicationData);
                
                showAlert('Solicitud enviada exitosamente. Recibirás una confirmación por email.', 'success');
                
                // Limpiar formulario
                setTimeout(() => {
                    if (confirm('¿Deseas crear una nueva solicitud?')) {
                        location.reload();
                    }
                }, 3000);

            } catch (error) {
                console.error('Error enviando solicitud:', error);
                showAlert('Error enviando la solicitud: ' + error.message, 'error');
            }
        }

        // Mostrar alerta
        function showAlert(message, type = 'info') {
            const alertContainer = document.getElementById('validation-alerts');
            const alertClass = {
                'success': 'bg-green-50 border-green-400 text-green-700',
                'error': 'bg-red-50 border-red-400 text-red-700',
                'warning': 'bg-yellow-50 border-yellow-400 text-yellow-700',
                'info': 'bg-blue-50 border-blue-400 text-blue-700'
            };

            const iconClass = {
                'success': 'fas fa-check-circle text-green-400',
                'error': 'fas fa-exclamation-circle text-red-400',
                'warning': 'fas fa-exclamation-triangle text-yellow-400',
                'info': 'fas fa-info-circle text-blue-400'
            };

            const alert = document.createElement('div');
            alert.className = `border-l-4 p-4 mb-4 rounded fade-in ${alertClass[type]}`;
            alert.innerHTML = `
                <div class="flex">
                    <div class="flex-shrink-0">
                        <i class="${iconClass[type]}"></i>
                    </div>
                    <div class="ml-3">
                        <p class="text-sm">${message}</p>
                    </div>
                    <div class="ml-auto pl-3">
                        <button class="text-gray-400 hover:text-gray-600" onclick="this.parentElement.parentElement.parentElement.remove()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
            `;

            alertContainer.appendChild(alert);

            // Auto-remover después de 5 segundos para alertas de éxito
            if (type === 'success') {
                setTimeout(() => {
                    if (alert.parentElement) {
                        alert.remove();
                    }
                }, 5000);
            }
        }

        // Limpiar uploads
        function clearFileUploads() {
            document.querySelectorAll('.upload-status').forEach(status => {
                status.innerHTML = '';
            });
            document.querySelectorAll('.progress-container').forEach(container => {
                container.classList.add('hidden');
            });
        }
    </script>
</body>
</html>
